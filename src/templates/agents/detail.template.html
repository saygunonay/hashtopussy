{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}
<h2>[[lang.get('agents_detail_agent_details')]]</h2>
{%TEMPLATE->struct/messages%}
<div class="panel panel-default">
  <table class="table table-bordered table-nonfluid">
    <tr>
      <th>[[lang.getUCF('property')]]</th>
      <th>[[lang.getUCF('value')]]</th>
    </tr>
    <tr>
      <td>[[lang.get('table_property_id')]]</td>
      <td>[[agent.getId()]]</td>
    </tr>
    {{IF [[login.getLevel()]] >= 30}}
      <tr>
        <td>[[lang.get('table_property_owner')]]</td>
        <td>
          <form class='form-inline' action="agents.php?id=[[agent.getId()]]" method="post">
            <input type='hidden' name='action' value='[[$DAgentAction::SET_OWNER]]'>
            <input type='hidden' name='agentId' value='[[agent.getId()]]'>
            <input type="hidden" name="csrf" value="[[csrf]]">
            <select class='form-control' name='owner'>
              <option value="">---</option>
              {{FOREACH user;[[users]]}}
                <option value='[[user.getId()]]'{{IF [[user.getId()]] == [[agent.getUserId()]]}} selected{{ENDIF}}>[[htmlentities([[user.getUsername()]], ENT_QUOTES, "UTF-8")]]</option>
              {{ENDFOREACH}}
            </select>
            <input type="submit" class='btn btn-default' value="[[lang.get('button_update_owner')]]">
          </form>
        </td>
      </tr>
    {{ENDIF}}
    <tr>
      <td>[[lang.get('table_property_active')]]</td>
      <td>
        {{IF [[agent.getUserId()]] == [[login.getUserId()]] || [[login.getLevel()]] >= 30}}
          <form id="active[[agent.getId()]]" action="agents.php?id=[[agent.getId()]]" method="post">
            <input type='hidden' name='action' value='[[$DAgentAction::SET_ACTIVE]]'>
            <input type="hidden" name="agentId" value="[[agent.getId()]]">
            <input type="hidden" name="csrf" value="[[csrf]]">
            <input type="checkbox" {{IF [[agent.getIsActive()]] == 1}} checked{{ENDIF}} onChange="javascript:document.getElementById('active[[agent.getId()]]').submit();">
          </form>
        {{ELSE}}
          <input type="checkbox" {{IF [[agent.getIsActive()]] == 1}} checked{{ENDIF}} disabled>
        {{ENDIF}}
      </td>
    </tr>

    <tr>
      <td>[[lang.get('table_property_machine_name')]]</td>
      <td>
        {{IF [[agent.getUserId()]] == [[login.getUserId()]] || [[login.getLevel()]] >= 30}}
          <form class='form-inline' id="name[[agent.getId()]]" action="agents.php?id=[[agent.getId()]]" method="post">
            <input type='hidden' name='action' value='[[$DAgentAction::RENAME_AGENT]]'>
            <input type="hidden" name="agentId" value="[[agent.getId()]]">
            <input type="hidden" name="csrf" value="[[csrf]]">
            <input type="text" name='name' value="[[agent.getAgentName()]]" class='form-control'>&nbsp;&nbsp;
            <input type='submit' class='btn btn-default' value='[[lang.get('button_change')]]'>
          </form>
        {{ELSE}}
          <input type="text" name='name' value="[[agent.getAgentName()]]" class='form-control' readonly>
        {{ENDIF}}
      </td>
    </tr>

    <tr>
      <td>[[lang.get('table_property_operating_system')]]</td>
      <td>[[Util::getStaticArray([[agent.getOs()]], 'os')]]</td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_access_token')]]</td>
      <td>[[agent.getToken()]]</td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_machine_id')]]</td>
      <td>[[agent.getUid()]]</td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_cpu_only')]]</td>
      <td>
        {{IF [[agent.getUserId()]] == [[login.getUserId()]] || [[login.getLevel()]] >= 30}}
          <form class='form-inline' action="agents.php?id=[[agent.getId()]]" method="post">
            <input type='hidden' name='action' value='[[$DAgentAction::SET_CPU]]'>
            <input type='hidden' name='agentId' value='[[agent.getId()]]'>
            <input type="hidden" name="csrf" value="[[csrf]]">
            <select class='form-control' name='cpuOnly'>
              <option value="0"{{IF [[agent.getCpuOnly()]] == 0}}selected{{ENDIF}}>[[lang.getUCF('no')]]</option>
              <option value="1"{{IF [[agent.getCpuOnly()]] == 1}}selected{{ENDIF}}>[[lang.getUCF('yes')]]</option>
            </select>
            <input type="submit" class='btn btn-default' value="[[lang.get('button_set')]]">
          </form>
        {{ELSE}}
          <input type="text" name='name' value="{{IF [[agent.getCpuOnly()]] == 0}}No{{ELSE}}Yes{{ENDIF}}" class='form-control' readonly>
        {{ENDIF}}
      </td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_graphic_cards')]]</td>
      <td>[[str_replace("\n","<br>",[[agent.getGpus()]])]]</td></tr>
    <tr>
      <td>[[lang.get('table_property_hashcat_version')]]</td>
      <td>[[agent.getHcVersion()]]</td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_extra_parameters')]]</td>
      <td>
        {{IF [[agent.getUserId()]] == [[login.getUserId()]] || [[login.getLevel()]] >= 30}}
          <form class='form-inline' action="agents.php?id=[[agent.getId()]]" method="POST">
            <input type="hidden" name="agentId" value="[[agent.getId()]]">
            <input type="hidden" name="action" value="[[$DAgentAction::SET_PARAMETERS]]">
            <input type="hidden" name="csrf" value="[[csrf]]">
            <input type="text" class='form-control' name="cmdpars" value="[[agent.getCmdPars()]]" size="30">
            <input type="submit" class='btn btn-default' value="[[lang.get('button_set')]]">
          </form>
        {{ELSE}}
          <input type="text" class='form-control' name="cmdpars" value="[[agent.getCmdPars()]]" size="30" readonly>
        {{ENDIF}}
      </td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_hashcat_errors')]]</td>
      <td>
        {{IF [[agent.getUserId()]] == [[login.getUserId()]] || [[login.getLevel()]] >= 30}}
          <form id="agentignore" action="agents.php?id=[[agent.getId()]]" method="post">
            <input type='hidden' name='action' value='[[$DAgentAction::SET_IGNORE]]'>
            <input type="hidden" name="agentId" value="[[agent.getId()]]">
            <input type="hidden" name="csrf" value="[[csrf]]">
            <input type="checkbox" name='ignore' value='1'{{IF [[agent.getIgnoreErrors()]] == 1}} checked{{ENDIF}} onChange="javascript:document.getElementById('agentignore').submit();">
            [[lang.getUCF('ignore')]] <br><i>[[lang.get('agents_detail_hashcat_errors_description')]]</i>
          </form>
        {{ELSE}}
          <input type="checkbox" name='ignore' value='1'{{IF [[agent.getIgnoreErrors()]] == 1}} checked{{ENDIF}} disabled>
        {{ENDIF}}
      </td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_trust')]]</td>
      <td>
        {{IF [[login.getLevel()]] >= 30}}
          <form id="agenttrusted" action="agents.php?id=[[agent.getId()]]" method="post">
            <input type='hidden' name='action' value='[[$DAgentAction::SET_TRUSTED]]'>
            <input type="hidden" name="agentId" value="[[agent.getId()]]">
            <input type="hidden" name="csrf" value="[[csrf]]">
            <input type="checkbox" name='trusted' value='1'{{IF [[agent.getIsTrusted()]] == 1}} checked{{ENDIF}} onChange="javascript:document.getElementById('agenttrusted').submit();">
            [[lang.get('agents_detail_trust_description')]]
          </form>
        {{ELSE}}
          <input type="checkbox" name='trusted' value='1'{{IF [[agent.getIsTrusted()]] == 1}} checked{{ENDIF}} disabled>
          [[lang.get('agents_detail_trust_description')]]
        {{ENDIF}}
      </td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_assignment')]]</td>
      <td>
        <form class='form-inline' action="agents.php?id=[[agent.getId()]]" method="post">
          <input type='hidden' name='action' value='[[$DAgentAction::ASSIGN_AGENT]]'>
          <input type='hidden' name='agent' value='[[agent.getId()]]'>
          <input type="hidden" name="csrf" value="[[csrf]]">
          <select class='form-control' name='task'>
            <option value="">([[lang.get('unassigned')]])</option>
            {{FOREACH task;[[allTasks]]}}
              <option value='[[task.getId()]]'{{IF [[task.getId()]] == [[currentTask]]}} selected{{ENDIF}}>[[task.getTaskName()]]</option>
            {{ENDFOREACH}}
          </select>
          <input type="submit" class='btn btn-default' value="[[lang.get('button_assign')]]">
        </form>
      </td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_last_activity')]]</td>
      <td>
        [[lang.getUCF('action')]]: [[agent.getLastAct()]]<br>
        [[lang.getUCF('time')]]: [[date([[config.getVal(DConfig::TIME_FORMAT)]], [[agent.getLastTime()]])]]<br>
        IP: <code>[[agent.getLastIp()]]</code>
      </td>
    </tr>
    <tr>
      <td>[[lang.get('table_property_time_spent_cracking')]]</td>
      <td>[[Util::sectotime([[timeSpent]])]]</td>
    </tr>
  </table>
</div>
{{IF [[sizeof([[errors]])]] > 0}}
  <h3>Error messages:</h3>
  {{IF [[login.getLevel()]] >= 30}}
    <form action="agents.php?id=[[agent.getId()]]" method='post' class='form-inline'>
      <input type='hidden' name='action' value='[[$DAgentAction::CLEAR_ERRORS]]'>
      <input type='hidden' name='agent' value="[[agent.getId()]]">
      <input type="hidden" name="csrf" value="[[csrf]]">
      <input type='submit' class='btn btn-danger' value='Delete All'>
    </form>
  {{ENDIF}}
  <br>
  <div class="panel panel-default">
    <table class="table table-bordered table-nonfluid">
      <tr>
        <th>Time</th>
        <th>Task</th>
        <th>Chunk</th>
        <th>Message</th>
      </tr>
      {{FOREACH error;[[errors]]}}
        <tr>
          <td>[[date([[config.getVal(DConfig::TIME_FORMAT)]], [[error.getTime()]])]]</td>
          <td>
            {{IF [[error.getTaskId()]] == null}}
              N/A
            {{ELSE}}
              <a href="tasks.php?id=[[error.getTaskId()]]">[[error.getTaskId()]]</a>
            {{ENDIF}}
          </td>
          <td>
            [[error.getId()]]
          </td>
          <td style="white-space: normal;">
            [[error.getError()]]
          </td>
        </tr>
      {{ENDFOREACH}}
    </table>
  </div>
{{ENDIF}}
<h3>[[lang.get('agents_detail_dispatched_chunks')]]</h3>
<div class="panel panel-default">
  <table class="table table-bordered table-nonfluid">
    <tr>
      <th>[[lang.get('table_property_id')]]</th>
      <th>[[lang.get('table_property_start')]]</th>
      <th>[[lang.get('table_property_length')]]</th>
      <th>[[lang.get('table_property_checkpoint')]]</th>
      <th>[[lang.get('table_property_progress')]]</th>
      <th>[[lang.get('table_property_task')]]</th>
      <th>[[lang.get('table_property_dispatch_time')]]</th>
      <th>[[lang.get('table_property_last_activity')]]</th>
      <th>[[lang.get('table_property_time_spent')]]</th>
      <th>[[lang.get('table_property_state')]]</th>
      <th>[[lang.get('table_property_cracked')]]</th>
    </tr>
    {{FOREACH chunk;[[chunks]]}}
      <tr>
        <td>[[chunk.getId()]]</td>
        <td class='num'>[[chunk.getSkip()]]</td>
        <td class='num'>[[chunk.getLength()]]</td>
        <td class='num'>
          [[chunk.getProgress()]]
          {{IF [[chunk.getProgress()]] > 0 && [[chunk.getProgress()]] != [[chunk.getLength()]]}}
            <br>([[Util::showperc([[chunk.getProgress()]], [[chunk.getLength()]])]]%)
          {{ENDIF}}
        </td>
        <td class='num'>
          [[Util::showperc([[chunk.getRprogress()]], 10000)]]%
        </td>
        <td>
          <a href='tasks.php?id=[[chunk.getTaskId()]]'>[[chunk.getTaskId()]]</a> <!-- TODO: put here task name -->
        </td>
        <td>
          {{IF [[chunk.getDispatchTime()]] == 0}}
            ([[lang.get('description_no_activity')]])
          {{ELSE}}
            [[date([[config.getVal(DConfig::TIME_FORMAT)]], [[chunk.getDispatchTime()]])]]
          {{ENDIF}}
        </td>
        <td>
          {{IF [[chunk.getSolveTime()]] == 0}}
            ([[lang.get('description_no_activity')]])
            </td>
            <td>
          {{ELSE}}
              [[date([[config.getVal(DConfig::TIME_FORMAT)]], [[chunk.getSolveTime()]])]]
            </td>
            <td class='num'>
              [[Util::sectotime(0)]] <!--TODO: get spent time on chunk-->
          {{ENDIF}}
        </td>
        <td>
          [[Util::getStaticArray([[chunk.getState()]], 'states')]]
        </td>
        <td>
          {{IF [[chunk.getCracked()]] > 0}}
            <a href="hashes.php?chunk=[[chunk.getId()]]">[[chunk.getCracked()]]</a>
          {{ENDIF}}
        </td>
      </tr>
    {{ENDFOREACH}}
  </table>
</div>
{%TEMPLATE->struct/foot%}
